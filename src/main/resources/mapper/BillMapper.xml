<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.neuedu.hismedicalsystem.model.mapper.BillMapper">

    <insert id="insertBill">
        insert into bill
        (totalprice, pid, count, billdate, isPaid, treatcat, isPrint, feecode, isDone, billcat)
        values
        (#{totalprice}, #{pid}, #{count}, now(), #{isPaid}, #{itemcode}, #{isPrint}, #{feecode}, #{isDone}, #{billcat})
    </insert>

    <sql id="getBillsByPid">
        select billid, totalprice, pid, count, billdate, isPaid, b.treatcat, isPrint, b.feecode, isDone, billcat,
        nm.itemname as itemname, f.feename as feename
        from bill b
        join non_medic nm on nm.itemcode = b.treatcat
        join fee f on f.feecode = b.feecode
        where pid = #{id}
    </sql>

    <select id="getBillsWithCondition" resultType="Bill">
        <include refid="getBillsByPid"></include>
        <where>
            <if test="isPaid != null and isPaid!='' ">
                and  b.isPaid = #{isPaid}
            </if>
            <if test="isDone != null and isDone!='' ">
                and  b.isDone = #{isDone}
            </if>
        </where>
    </select>

    <update id="changeStateToPaid">
        update bill set isPaid = true
        where billid = #{billId}
    </update>

    <!--  ADD BILLING OF OUTPATIENT PART  -->
    <insert id="addExamToBill" useGeneratedKeys="true" keyProperty="billid">
        insert into his.bill(totalprice, pid, count, billdate, isPaid, treatcat, isPrint, feecode, isDone, billcat, treatid) values
        <foreach item="item" collection="items" separator=",">
            (#{item.price}, #{pid}, 1, now(), 0, 'exam', 0, #{item.feecode}, 0, #{billcat}, #{item.exid})
        </foreach>
    </insert>

    <insert id="addPreToBill" useGeneratedKeys="true" keyProperty="billid">
        insert into his.bill(totalprice, pid, count, billdate, isPaid, treatcat, isPrint, feecode, isDone, billcat, treatid) values
        (#{price}, #{pid}, 1, now(), 0, 'prescription', 0, #{feecode}, 0, #{billcat}, #{preid})
    </insert>
</mapper>
