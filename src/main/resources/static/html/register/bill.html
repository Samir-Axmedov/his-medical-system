<html>

<head>
    <title>HIS System</title>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- import Vue before Element -->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
<div id="bill">

    <el-col :span="24">
        <el-row>
            <el-input style="padding: 3%; width: 30%" placeholder=" Enter Patient ID" v-model="pid"
                      size="large"></el-input>
            <el-button icon="el-icon-search" type="primary" @click="searchPatient">Search</el-button>
            <el-select v-model="paytype" placeholder="Method" style="width: 10%; left: 25%">
                <el-option v-for="item in paytypes" :key="item" :label="item" :value="item">
                </el-option>
            </el-select>
            <el-button style="position: relative; left: 27%" icon="el-icon-coin" type="primary"
                       @click="showConfirmPayDialogForm">Pay
            </el-button>
        </el-row>
        <el-row>
            <el-form :inline="true" class="demo-form-inline">
                <el-input id="name" style="width: 24vw; pointer-events: none; padding: 1%"
                          placeholder="Name: "></el-input>
                <el-input id="age" style="width: 15vw; pointer-events: none; padding: 1%"
                          placeholder="Age: "></el-input>
                <el-input id="bdate" style="width: 22vw; pointer-events: none; padding: 1%"
                          placeholder="Birth date:"></el-input>
                <el-input id="gender" style="width: 22vw; pointer-events: none; padding: 1%"
                          placeholder="Gender:"></el-input>
                <el-input id="address" style="width: 42vw; pointer-events: none; padding: 1%"
                          placeholder="Address:"></el-input>
                <el-input id="billcat" style="width: 45vw; pointer-events: none; padding: 1%"
                          placeholder="Billing category: "></el-input>
            </el-form>
        </el-row>
    </el-col>

    <el-table ref="billstable" :data="bills" style="width: 90%; padding-left: 5%" @selection-change="addToPayment">
        <el-table-column type="selection" width="70"></el-table-column>
        <el-table-column prop="billid" label="ID" width="140"></el-table-column>
        <el-table-column prop="itemcode" label="Item code" width="140"></el-table-column>
        <el-table-column prop="billdate" label="Date" width="140"></el-table-column>
        <el-table-column prop="totalprice" label="Price" width="140"></el-table-column>
        <el-table-column prop="feecode" label="Fee code" width="140"></el-table-column>
    </el-table>

    <!-------------    CONFIRM PAYMENT POP-UP    ------------>
    <el-dialog style="left: 190px" title="Confirm payment" :visible.sync="confirmPayFormVisible">
        <el-table :data="payments" style="top: -15px;height: fit-content;width: 100%; padding-left: 5%">
            <el-table-column prop="itemname" label="Item" width="220"></el-table-column>
            <el-table-column prop="price" label="Price" width="220"></el-table-column>
        </el-table>
        <el-col>
            <el-input id="ttl" size="small" v-model="totalfee" style="pointer-events: none; padding: 1%"
                      placeholder="Total: "></el-input>
            <el-input size="small" style="padding: 1%" v-model="receivedpayment" placeholder="Received"></el-input>
            <el-input id="chg" size="small" v-model="change" style="pointer-events: none; padding: 1%"
                      placeholder="Change: "></el-input>
        </el-col>
        <div slot="footer" class="dialog-footer">
            <el-button type="primary" icon="el-icon-coin" @click="onConfirmPay">Confirm</el-button>
        </div>
    </el-dialog>
    <el-dialog style="left: 240px; width: 500px" title="Confirm payment" :visible.sync="confirmWeChatFormVisible">
        <img style="left: 35px; width: 190px; height: auto;" src="../../img/wechat-qr.jpg"/>
    </el-dialog>
    <el-dialog style="left: 240px; width: 500px" title="Confirm payment" :visible.sync="confirmAlipayFormVisible">
        <img style="left: 35px; width: 190px; height: auto;" src="../../img/alipay-qr.jpg"/>
    </el-dialog>
    <el-dialog style="left: 240px" title="Oops" :visible.sync="confirmErrFormVisible">
        <h4>Please, select a payment method...</h4>
    </el-dialog>
</div>
</body>


<script>
    var app = new Vue({
        el: '#bill',
        data: {
            pid: "",
            receivedpayment: "",
            confirmPayFormVisible: false,
            confirmWeChatFormVisible: false,
            confirmAlipayFormVisible: false,
            confirmErrFormVisible: false,
            dialogpatientname: "",
            dialogpatientid: "",
            pname: "",
            date: "",
            aorp: "",
            deptname: "",
            registrationLevel: "",
            state: "",
            confirmFormIndex: "",
            confirmObject: "",
            totalfee: "",
            change: "",
            itemname: "",
            price: "",
            att: "",
            paytype: "",

            payments: [],
            bills: [],
            registrations: [],
            billstable: [],
            paytypes: ["WeChat", "Alipay", "Cash"],
        },

        mounted: function() {
            console.log("refreshed")
            var that = this;

            axios.post('/registration/getRegistrations', {})
                .then(function(response) {
                    console.log(response.data);
                    that.patients = response.data;
                })
                .catch(function(error) {
                    console.log(error);
                });
        },

        methods: {
            refresh: function() {
                console.log("refresh!!!")
                this.currentPage = 1;
                var that = this;
                that.patients = [];
                axios.post('/registration/patients', {})
                    .then(function(response) {
                        console.log(response.data);
                        that.patients = response.data;
                    })
                    .catch(function(error) {
                        console.log(error);
                    });
            },

            showConfirmPayDialogForm: function(index, row) {
                if (this.paytype == "WeChat") {
                    this.confirmWeChatFormVisible = true;
                } else if (this.paytype == "Alipay") {
                    this.confirmAlipayFormVisible = true;
                } else if (this.paytype == "Cash") {
                    this.confirmPayFormVisible = true;
                } else {
                    this.confirmErrFormVisible = true;
                }
                this.confirmFormIndex = index;
                this.confirmObject = row;


                this.dialogitem = row.pname;
                this.dialogprice = row.feecode;
            },

            onConfirmPay: function() {
                var params = new URLSearchParams();
                params.append('pid', this.confirmObject);
                axios.post('/registration/getRegistrationPrice', params)
                    .then(function(response) {

                    })
                    .catch(function(error) {
                        console.log(error);
                    });
                this.confirmPayFormVisible = false;
                this.refresh();
            },

            searchPatient: function() {
                //get data from database
                let that = this;
                console.log("Search")
                axios.post('/registration/tryCompletePatientInfo', {
                        pid: that.pid
                    })
                    .then(function(response) {
                        that.patient = response.data;
                        console.log(that.users);
                    })
                    .catch(function(error) {
                        console.log(error);
                    });

                //config Strings
                let nameString = `Name: ${that.pname}`;
                let ageString = `Age: ${that.page}`;
                let bdateString = `Birth date: ${that.pbirth}`;
                let genderString = `Gender: ${that.pgender}`;
                let addressString = `Address: ${that.paddress}`;
                let billcatString = `Billing category: ${that.billcat}`;

                document.getElementById("name").setAttribute("placeholder", nameString);
                document.getElementById("age").setAttribute("placeholder", ageString);
                document.getElementById("bdate").setAttribute("placeholder", bdateString);
                document.getElementById("gender").setAttribute("placeholder", genderString);
                document.getElementById("address").setAttribute("placeholder", addressString);
                document.getElementById("billcat").setAttribute("placeholder", billcatString);
            },
            toggleSelection(rows) {
                if (rows) {
                    rows.forEach(row => {
                        this.$refs.billstable.toggleRowSelection(row);
                    });
                } else {
                    this.$refs.billstable.clearSelection();
                }
            },
            addToPayment(val) {
                this.billstable = val;
            }
        }
    })
</script>

</html>